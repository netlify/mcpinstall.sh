export const prerender = false;
---
import Layout from "../../layouts/Layout.astro";
import { generateGenericConfig } from "../../utils/configs";
import { getClientById } from "../../utils/clientData";

const { encodeddata, clientId } = Astro.params;
const decodedData = encodeddata && JSON.parse(atob(decodeURIComponent(encodeddata)));

const mcpServerName = decodedData?.name ? `"${decodedData.name}" MCP Server` : "MCP Server";
const client = getClientById(clientId as string);

if (!client) {
  return Astro.redirect(`/${encodeddata}`);
}

const clientSpecificConfig = client.generateConfig(decodedData);
---

<Layout />
<main class="min-h-screen flex flex-col bg-[#fdf6e3] text-navy font-sans py-8">
  <!-- Header with back button -->
  <div class="w-full max-w-6xl mx-auto px-4 mb-8">
    
    
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 flex items-center justify-center">
          <img src={client.imageUrl} alt={`${client.name} icon`} class="w-10 h-10 object-contain" />
        </div>
        <h1 class="text-3xl font-bold">
          Install {mcpServerName} in {client.name}
        </h1>
      </div>
      <a 
        href={`/${encodeddata}`}
        class="text-md text-gray-500 hover:text-[#006f92] transition-colors duration-200 underline decoration-dotted underline-offset-4"
      >
        Using a different MCP client?
      </a>
    </div>
    <div class="my-8 bg-[#eee8d5] p-4 rounded-lg">
      <h3 class="font-semibold mb-2">What is the {mcpServerName}?</h3>
      <p>{decodedData?.desc || 'No server description provided'}</p>
    </div>
  </div>
  
  <div class="w-full max-w-6xl mx-auto flex flex-col lg:flex-row gap-12 px-4">
    <!-- Left column: Instructions -->
    <div class="flex-1">
      <h2 class="text-2xl font-semibold mb-4">Installation Steps</h2>
      
      <div class="bg-white border border-[#1a2946] rounded-lg p-6 mb-6">
        <ol class="space-y-4">
          {client.instructions.map((instruction, index) => (
            <li class="flex gap-4">
              <span class="flex-shrink-0 w-8 h-8 bg-[#1a2946] text-white rounded-full flex items-center justify-center font-bold text-sm">
                {index + 1}
              </span>
              <span class="pt-1">{instruction}</span>
            </li>
          ))}
        </ol>
      </div>
      
      
      
      {client.docs && (
        <div class="bg-white border border-[#006f92] rounded-lg p-4">
          <h3 class="font-semibold mb-2">Need Help?</h3>
          <p class="mb-3">Check the official documentation for more detailed instructions:</p>
          <a 
            href={client.docs} 
            target="_blank" 
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 text-[#006f92] hover:text-[#1a2946] transition-colors duration-200"
          >
            <span>View {client.name} MCP Documentation</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
              <path d="M7 17L17 7"/>
              <path d="M7 7h10v10"/>
            </svg>
          </a>
        </div>
      )}
    </div>

    <!-- Right column: Configuration -->
    <div class="flex-1">
      
      {clientSpecificConfig && (
        <>
          <h2 class="text-2xl font-semibold mb-4">Server Configuration</h2>
          <p class="mb-4">
            Copy and paste this configuration into your {client.name} MCP settings:
          </p>

          <div class="bg-[#eee8d5] p-4 rounded-lg mb-6">
            <h3 class="font-semibold mb-2">Configuration Location</h3>
            <code class="text-sm">{client.configLocation}</code>
          </div>
          
          <pre class="bg-[#1a2946] text-[#fdf6e3] p-4 rounded-lg font-mono text-sm overflow-auto mb-6">
{JSON.stringify(clientSpecificConfig, null, 2)}
          </pre>
          
          <div class="bg-white border border-[#1a2946] rounded-lg p-4">
            <h3 class="font-semibold mb-2">Quick Copy</h3>
            <p class="text-sm mb-3">Click the button below to copy the configuration to your clipboard:</p>
            <button 
              id="copy-config"
              class="bg-[#1a2946] hover:bg-[#006f92] text-white px-4 py-2 rounded transition-colors duration-200"
            >
              Copy Configuration
            </button>
          </div>
        </>
      )}
    </div>
  </div>
</main>

<script>
  document.getElementById('copy-config')?.addEventListener('click', async () => {
    const config = document.querySelector('pre')?.textContent;
    if (config) {
      try {
        await navigator.clipboard.writeText(config);
        const button = document.getElementById('copy-config');
        if (button) {
          const originalText = button.textContent;
          button.textContent = 'Copied!';
          button.classList.add('bg-green-600');
          button.classList.remove('bg-[#1a2946]', 'hover:bg-[#006f92]');
          setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-600');
            button.classList.add('bg-[#1a2946]', 'hover:bg-[#006f92]');
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy configuration:', err);
      }
    }
  });
</script>
